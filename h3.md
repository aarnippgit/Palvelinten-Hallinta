# h3 Soitto kotiin

## x) Lue ja tiivistä

### Karvinen 2021: Two Machine Virtual Network With Debian 11 Bullseye and Vagrant

Vagrant:
-Automatisoi VirtualBox-koneiden asennuksen ja SSH-kirjautumisen
-Ei tarvitse graafista käyttöliittymää

Vagrant Windowsille:

[https://developer.hashicorp.com/vagrant/install] - AMD64

-Luo uusi hakemisto projetkille ja tallenna sinne Vagrantfile

-Hostiin voi kirjautua SSH:lla, virtuaalikoneet ovat yhteydessä toisiinsa verkon kautta.

-Vanhojen virtuaalikoneiden tuhoaminen ja uusien luominen helppoa

-Jotkut järjestelmät rajoittaa mitä IP-osoitteita voi valita, virheilmoitus kertoo miltä väliltä voi käyttää

-ipcalc antaa pienimmän ja suurimman käytettävän osoitteen, vaihda IP Vagrantfilessä 


### Karvinen 2018: Salt Quickstart – Salt Stack Master and Slave on Ubuntu Linux
-Asenna Master

-Jos Masterilla on palomuuri, avaa portit 4505/tcp ja 4506/tcp

-Asenna Slave

-Slaven pitää tietää missä Master on, sille voi antaa id:n tai käyttää hostnamea, jokaisen Slaven nimi pitää olla uniikki

-Hyväksy Slaven avain Masterilla

-Aja pari komentoa Masterilla varmistaaksesi että Slavet vastaa


### Karvinen 2023: Salt Vagrant - automatically provision one master and two slaves

Infra as Code - Your wishes as a text file

-Luodaan uusi kansio /srv/salt/*nimi*, sinne sls-tiedosto johon kirjoitetaan koodi


top.sls - What Slave Runs What States

-Top file määrittää mitä tiloja millekin Slavelle ajetaan


## Ympäristö:

* Host OS: Windows 11 Home 24H2 26100.6584
* VirtualBox 7.2.2
* Debian 13 Trixie
* Base Memory: 4000 MB
* Processors: 2
* Storage: 60 GB


## a) Hello Vagrant! Osoita jollain komennolla, että Vagrant on asennettu. Jos et ole vielä asentanut niitä, raportoi myös Vagrant ja VirtualBox asennukset.

Asensin Vagrantin, VirtualBox löytyi jo.

Latasin Vagrantin [täältä](https://developer.hashicorp.com/vagrant/install) (AMD64, kun Windowsilla operoidaan). Ajoin installerin ja käynnistin koneeni uudelleen. Tämän jälkeen vielä testasin Vagrantin olemassaolon Powershellissä komennolla:
```
vagrant --version
```



<img width="384" height="61" alt="Vagrant_asennettu" src="https://github.com/user-attachments/assets/9c20eeb7-4ed1-4a74-972a-649600b43fe0" />

Siellähän se.

## b) Linux Vagrant. Tee Vagrantilla uusi Linux-virtuaalikone.

Tässä tehtävässä avuksi oli Antti Salmisen [raportti](https://oispadotka.wordpress.com/2020/05/12/h6/) Vagrantilla uuden virtuaalikoneen luomisesta, sekä Vagrantin oma [Quick start opas](https://developer.hashicorp.com/vagrant/tutorials/get-started/setup-project).

Loin kansion debianbookworm64 ja siirryin sihen. Loin Vagrantfilen komennolla
 ```
vagrant init debian/bookworm64
```
<img width="623" height="237" alt="Vagrantfile_1" src="https://github.com/user-attachments/assets/579e60a8-76bd-46fb-9745-e27921c57860" />

Vagrantfilessä asetin hostnameksi kone1.

<img width="330" height="292" alt="ensimmäinen_vm_kone1" src="https://github.com/user-attachments/assets/15caec86-c4fc-42b2-b882-1980d6bb8c76" />


Tämän jälkeen käynnistin luomani virtuaalikoneen.
```
vagrant up
```

<img width="827" height="465" alt="kone1_käynnissä" src="https://github.com/user-attachments/assets/415f6ec2-4327-4eae-9675-76286ed14eca" />


Virtuaalikone käynnistyi, kokeilin vielä yhdistää siihen SSH:lla.
```
Vagrant ssh kone1
```

<img width="789" height="194" alt="kone1_ssh_onnistuu" src="https://github.com/user-attachments/assets/f975b30b-cccf-4dcb-839a-8e504cb73a1c" />

Onnistui.

## c) Kaksin kaunihimpi. Tee kahden Linux-tietokoneen verkko Vagrantilla. Osoita, että koneet voivat pingata toisiaan.

Aloitin tekemällä uuden kansion nimellä tupladebian, johon loin Vagrantfilen komennolla
```
vagrant init debian/bookworm64
```


<img width="612" height="497" alt="tupladebian_vagrantfile" src="https://github.com/user-attachments/assets/ba5cfa58-e101-4b4d-9386-5e779e9928e3" />


Vagrantfilessä määritin luotavaksi kaksi virtuaalikonetta, k1 ja k2. Oletuskansion sijaan jaettu kansio luotiin samaan kansioon jossa Vagrantfile sijaitsee. Asetin myös koneiden VirtualBoxissa näkyvät nimet samoiksi kuin niiden hostnamet jotta ne on helpompi tunnistaa. Koneet ovat yksityisessä verkossa.

<img width="428" height="168" alt="vagrantkoneet" src="https://github.com/user-attachments/assets/5471cda2-4e15-4085-9a3d-43b4bf6f2c03" />

Kirjauduin molempiin koneisiin ssh:lla ja kokeilin niiden välistä yhteyttä pingaamalla.

<img width="567" height="133" alt="k1_ping_k2" src="https://github.com/user-attachments/assets/2cdc8e6d-f905-47f1-9e70-0b489254d29a" />


<img width="568" height="132" alt="k2_ping_k1" src="https://github.com/user-attachments/assets/0561e37c-9f9d-4091-a5bd-5dbfb9bba43e" />


Hyvin pingaa

## d) Herra-orja verkossa. Demonstroi Salt herra-orja arkkitehtuurin toimintaa kahden Linux-koneen verkossa, jonka teit Vagrantilla. Asenna toiselle koneelle salt-master, toiselle salt-minion. Laita orjan /etc/salt/minion -tiedostoon masterin osoite. Hyväksy avain ja osoita, että herra voi komentaa orjakonetta.

Yhdistin edellisessä tehtävässä luomiini koneiseen (k1, k2) ja asensin niihin salt-masterin ja salt-minionin.

Slavella lisäsin tiedostoon /etc/salt/minion masterin IP:n,


<img width="317" height="39" alt="masterin_ip" src="https://github.com/user-attachments/assets/a63bf52c-492b-4be3-9cec-67845cc3a50a" />


jonka jälkeen käynnistin salt-minionin uudelleen ja hyväksyin Masterilla avaimen.

<img width="407" height="225" alt="Master_hyväksyy_avaimen" src="https://github.com/user-attachments/assets/dd6d0558-5a41-45de-8d62-6569f1a3deab" />


Tämän jälkeen kokeilin toimivuutta:

<img width="412" height="80" alt="Masterin_kutsu" src="https://github.com/user-attachments/assets/9d5e0a2f-41e0-4597-a4c4-264e85cf73d9" />

## e) Kokeile vähintään kahta tilaa verkon yli (viisikosta: pkg, file, service, user, cmd)

Loin Masterille kansion /srv/salt/test/ ja sinne init-tiedoston.

<img width="291" height="153" alt="testi_init" src="https://github.com/user-attachments/assets/55c67634-aa5e-4556-913f-5d0d3eaa85f3" />

Testasin sen toimintaa komennolla 
```
$ sudo salt '*' state.apply test
```

<img width="605" height="702" alt="test_toimi" src="https://github.com/user-attachments/assets/a82ba95d-6d49-4dcb-8649-89a1cc4f81ef" />

Tulos oli lupaava, tarkisin vielä Slavella tulokset:

<img width="336" height="37" alt="k2_testitiedosto" src="https://github.com/user-attachments/assets/fc023d22-db13-4771-85cd-742eda939de8" />

Testitiedosto löytyi.

<img width="228" height="155" alt="tree_asennettu" src="https://github.com/user-attachments/assets/27176c0e-66b8-4d4c-8fb0-ad7585de7bb2" />

Samoin tree.

Ajoin komennon lopuksi vielä uudestaan:

<img width="578" height="531" alt="uusinta_ajo_testille" src="https://github.com/user-attachments/assets/fb43cddb-5767-428e-934d-76506f617834" />


## Lähteet

[https://terokarvinen.com/palvelinten-hallinta/]

[https://terokarvinen.com/2021/two-machine-virtual-network-with-debian-11-bullseye-and-vagrant/]

[https://terokarvinen.com/2018/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/]

[https://terokarvinen.com/2023/salt-vagrant/]

[https://oispadotka.wordpress.com/2020/05/12/h6/]

[https://developer.hashicorp.com/vagrant/tutorials/get-started/setup-project]
