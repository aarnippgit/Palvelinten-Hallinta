# H2 Kotitehtävät

## X) lue ja tiivistä

### Hello Salt Infra-as-Code

Asenna Salt
```
$ sudo apt-get update
$ sudo apt-get -y install salt-minion
```
Asenna micro
```
$ sudo apt-get -y install micro
$ export EDITOR=micro
```
Luo kansio moduulille
```
$ sudo mkdir -p /srv/salt/hello/
$ cd /srv/salt/hello/
```
Kirjoita infraa koodina
```
$ sudoedit init.sls
 	/tmp/hellotero:
  	  file.managed
```
Ajetaan
```
$ sudo salt-call --local state.apply hello
```
Tarkistetaan että Salt teki mitä piti
```
$ ls /tmp/hellotero
 	/tmp/hellotero
```
Idempotenssi - ensimmäisellä kerralla ajettaessa Salt teki halutun muutoksen. Komentoa toistamalla mitään uutta ei tapahdu.


### Salt contributors: Salt overview


1.	Rules of YAML
-Oletusrenderöijä monille Saltin käyttämille tiedostoille.
-Muuttaa tietoa YAMLista Pythoniin Saltia varten.

Perussäännöt:
-"Key: value"-parit.
-": " käytetään merkkaamaan "key: value"-paria.
-Avainten arvot voivat olla monissa eri rakenteissa.
-Kaikki avaimet ja ominaisuudet case-sensitive.
-Käytä vain välilyöntejä syvennyksiin.
-"#" aloittaa kommentin.

2. YAML simple structure
Kolme perus elementtityyppiä:
Scalars - "key: value"-pari jossa arvo voi olla numero, string tai Boolean.
Lists - "key: " jota seuraa lista arvoja, jossa jokainen arvo on erillisellä rivillä ja niitä edeltää kaksi väliä ja väliviiva.
Dictionaries - kokoelma "key: value"-pareja sekä listoja.

3. Lists and dictionaries - YAML block structures
-YAML on organisoitu lohkorakenteiksi.
-Sisennys luo kontekstin. Vähintään yhden välilyönnin sisennys, kaksi on standardi.
-Kokoelma, joka on lista, tai sanakirja lohkojakso, osoittaa jokaisen sisältämänsä rivin väliviivalla ja -lyönnillä.


### Salt contributors: The top file

1.	Introduction
Top file on tiedosto joka sisältää verkossa olevien järjestelmäryhmien määritykset sekä niihin sovellettavat roolit.

2. A basic example
Top filellä on kolme komponenttia:

Environment: tilapuuhakemisto joka sisältää setin tiedostoja järjestelmien määrittämistä varten.
Target: Ryhmä koneita joihin tiloja sovelletaan.
State files: Lista tilatiedostoja joita kohteeseen voi soveltaa. Jokainen tilatiedosto kuvailee yhden tai useamman tilan jolla kohdejärjestelmiä määritetään.
```
base:
  'web*':
    - apache
```

Ympäristö:
* Host OS: Windows 11 Home
* VirtualBox 7.2.2
* Debian 13 Trixie
* Base Memory: 4000 MB
* Processors: 2
* Storage: 60 GB

## a) Hei infrakoodi!

Tein sls-tiedoston joka luo tiedoston /tmp/-kansioon.

Ensin loin uuden kansion tiedostoani varten
```
$ sudo mkdir -p /srv/salt/testi
```
Siirryin luomaani kansioon
```
$ cd /srv/salt/testi
```
Loin uuden "init.sls"-tiedoston komennolla 
```
$ sudoedit init.sls
```
Kirjoitin koodin

<img width="226" height="87" alt="sls-testi" src="https://github.com/user-attachments/assets/e82bbffe-d080-46b7-afb4-306450cf02c6" />

Tallennettuani kokeilin toimiiko kirjoittamani tiedosto:
```
$ sudo salt-call --local state.apply testi
```

<img width="503" height="380" alt="testitiedosto_luotu" src="https://github.com/user-attachments/assets/de8af3bd-e707-49b1-bb21-b4d476aae82f" />


Tiedosto luotiin, ja tarkistin vielä sen olemassaolon

  
<img width="442" height="165" alt="testitiedosto_löytyy" src="https://github.com/user-attachments/assets/d683cb45-c5e7-4fd6-bfb6-5b1e6589d96d" />


## b) Toppping.
Loin uuden top filen.

Aloitin siirtymällä kansioon /srv/salt/ ja luomalla uuden top.sls-tiedoston komennolla
```
$ sudoedit top.sls
```

<img width="241" height="129" alt="top_filen_sisukset" src="https://github.com/user-attachments/assets/f314a05d-cf34-4383-b65a-2443a161d5f2" />



<img width="317" height="34" alt="tallessa_on" src="https://github.com/user-attachments/assets/1dcfd1d1-e54f-40ee-9379-895d568ecfda" />

Testasin toimiiko luomani tiedosto:
```
$ sudo salt-call --local state.apply
```



<img width="1062" height="551" alt="top_file_toimi" src="https://github.com/user-attachments/assets/644270b3-261e-42e1-94bc-c65b0892f214" />


Top file toimi mutta muutoksia ei tehty, sillä molemmat luotavat tiedostot olivat jo olemassa.


## c) Viisikko tiedostossa.

Tein erilliset esimerkit viidestä tärkeimmästä tilafunktiosta.

### 1. Pkg
   
Loin kansion hellopkg ja siirryin siihen.
```
$ sudo mkdir -p /srv/salt/hellopkg/
$ cd /srv/salt/hellopkg/
$ sudoedit init.sls
```
Kirjoitin koodin init-tiedostoon:

<img width="201" height="87" alt="tree_init" src="https://github.com/user-attachments/assets/409c5185-459e-4c48-ba86-915833c6f508" />

Ajettaessa ohjelma tarkistaa onko tree asennettuna ja uusimmassa versiossa.
```
$ sudo salt-call --local state.apply hellopkg
```

<img width="820" height="339" alt="tree_init_toimii" src="https://github.com/user-attachments/assets/ac64ba60-b87c-430c-befa-7663d160b071" />

Toimii, tree olikin jo asennettuna.

### 2. File

Loin kansion hellofile ja siirryin siihen
```
$ sudo mkdir -p /srv/salt/hellofile/
$ cd /srv/salt/hellofile/
$ sudoedit init.sls
```
Kirjoitin koodin init-tiedostoon:

<img width="345" height="91" alt="file_esimerkkikuva" src="https://github.com/user-attachments/assets/89fbff8e-4de6-47ce-9ed3-a8fac8cc15d1" />

Ajettaessa ohjelma luo tiedoston ja asettaa sen siällöksi "Tässä on tekstiä", jos sellaista ei ole vielä olemassa.

```
$ sudo salt-call --local state.apply hellofile
```

<img width="840" height="396" alt="hellofile_toimii" src="https://github.com/user-attachments/assets/747772c6-553c-432b-ac2a-286b7733b900" />

Tarkistin vielä että tiedosto oikeasti löytyy

<img width="570" height="36" alt="filedemo_on_olemassa" src="https://github.com/user-attachments/assets/260ee428-5d11-4281-9830-cf6eb43f9174" />

### 3. Service

Loin kansion helloservice ja siirryin siihen
```
$ sudo mkdir -p /srv/salt/helloservice/
$ cd /srv/salt/helloservice/
$ sudoedit init.sls
```
Kirjoitin koodin init-tiedostoon:

<img width="188" height="71" alt="helloservice_init" src="https://github.com/user-attachments/assets/137706f6-bd01-4e56-806b-8b43c4b4723c" />

Ajettaessa ohjelma tarkistaa onko ufw päällä ja käynnistää sen, jos se ei ole.
```
$ sudo salt-call --local state.apply helloservice
```

<img width="897" height="340" alt="helloservice_toimii" src="https://github.com/user-attachments/assets/7629e312-c49a-48ed-a889-d62da01a51c1" />


### 4. User

Loin kansion hellouser ja siirryin siihen
```
$ sudo mkdir -p /srv/salt/hellouser/
$ cd /srv/salt/hellouser/
$ sudoedit init.sls
```
Kirjoitin koodin init-tiedostoon:

<img width="178" height="76" alt="hellouser_init" src="https://github.com/user-attachments/assets/a0fba14d-788a-4a51-9895-bb51726eb728" />

Ajettaessa ohjelma luo käyttäjän "aapee" jos sitä ei vielä ole.

```
$ sudo salt-call --local state.apply hellouser
```

<img width="839" height="721" alt="hellouser_toimii" src="https://github.com/user-attachments/assets/959b1c10-79c5-44c3-9367-85bf59c83d50" />

Käyttäjä "aapee" luotiin.

### 5. Cmd

Loin kansion hellocmd ja siirryin siihen
```
$ sudo mkdir -p /srv/salt/hellocmd/
$ cd /srv/salt/hellocmd/
$ sudoedit init.sls
```
Kirjoitin koodin init-tiedostoon:


<img width="318" height="112" alt="hellocmd_init" src="https://github.com/user-attachments/assets/c9700b47-9465-4c91-bc2d-a60dd9203c17" />

Ohjelma luo tiedoston "hellocmd" kansioon /tmp/ jos sitä ei vielä ole olemassa.

```
$ sudo salt-call --local state.apply hellocmd
```

<img width="821" height="491" alt="hellocmd_toimii" src="https://github.com/user-attachments/assets/53d2fc17-e8f6-4e02-8160-5668c8287443" />

## d) Sls-tiedosto
Tein sls-tiedoston joka käyttää kahta tilafunktiota.

Loin uuden kansion, siirryin siihen ja loin uuden sls-tideoston
```
$ sudo mkdir -p /srv/salt/montasamassa/
$ cd /srv/salt/montasamassa/
$ sudoedit init.sls
```
<img width="280" height="217" alt="kahden_tilan_sls" src="https://github.com/user-attachments/assets/5fc34d7a-fa03-49d7-afdb-96818e4ed7d4" />

Ohjelma tarkistaa onko ufw asennettu, asentaa jos ei ole ja käynnistää, jos se ei ole käynnissä.

```
$ sudo salt-call --local state.apply montasamassa
```

<img width="900" height="531" alt="kahden_tilan_sls_toimii" src="https://github.com/user-attachments/assets/2fd1a879-09c5-4f3f-a125-c64225261d77" />

Ufw oli jo asennettu ja päällä, joten mitään muutoksia ei tehty.



<img width="896" height="530" alt="kahden_tilan_sls_uusi_ajo" src="https://github.com/user-attachments/assets/3e6fbb3d-f41a-44dc-8e1c-3e66c0c8cff4" />

Uudestaan ajettaessa mikään ei muutu.


## Lähteet
https://terokarvinen.com/palvelinten-hallinta/

https://terokarvinen.com/2024/hello-salt-infra-as-code/

https://docs.saltproject.io/salt/user-guide/en/latest/topics/overview.html#rules-of-yaml

https://docs.saltproject.io/en/latest/ref/states/top.html
