# h6 Miniprojekti

Tein projektini yhdessä [Miro Johanssonin](https://github.com/mk-tali) kanssa. Suunnitelma oli automatisoida TeamSpeak 3 -palvelimen asennus Saltin avulla.


## Kokeiluvaihe

Aloitimme testailemalla manuaalista asennusta. Tein omani Vagrant-virtuaalikoneella. Tein Vagrantfilen joka luo kaksi konetta, masterin ja slave/palvelinkoneen.


<img width="848" height="1189" alt="Vagrantfile_kaks_konetta" src="https://github.com/user-attachments/assets/8218798b-7822-4708-a277-7d7151de4974" />



Tässä kohtaa käytin vain palvelinkonetta testatakseni täysin normaalia asennusta:
Asensin ufw:n, lisäsin käyttäjän "teamspeak" ja annoin sille salasanan, jonka jälkeen vaihdoin uudelle käyttäjälle ja siirryin sen kotihakemistoon. Tämän jälkeen latasin wgetilla uusimman [ts3-palvelimen](https://www.teamspeak.com/en/downloads/#server), tässä tapauksessa Linux 64-bit 3.13.7.
Poistuin käyttäjältä ja asensin ohjelman lbzip2 ladatun tiedoston purkamista varten. Ideaalisti sen olisi asentanut etukäteen ylimääräisen poukkoilun välttämiseksi. Siirryin takaisin vaihdoin taas teamspeakille, purin tiedoston ja kopioin sen sisällöt kotihakemistoon.
```
teamspeak$ tar -xf teamspeak3-server_linux_amd64-3.13.7.tar.bz2
teamspeak$ cd teamspeak3-server_linux_amd64
teamspeak$ cp * -R /home/teamspeak
```
Loin vielä ".ts3server_license_accepted"-tiedoston hyväksyäkseni lisenssin ja poistuin käyttäjältä.
```
teamspeak$ touch .ts3server_license_accepted
```
Tämän jälkeen loin tiedoston ts3server.service,
```
$ sudo nano /lib/systemd/system/ts3server.service

[Unit]
Description=Teamspeak Service
Wants=network.target

[Service]
WorkingDirectory=/home/teamspeak
User=teamspeak
ExecStart=/home/teamspeak/ts3server_minimal_runscript.sh
ExecStop=/home/teamspeak/ts3server_startscript.sh stop
ExecReload=/home/teamspeak/ts3server_startscript.sh restart
Restart=always
RestartSec=15

[Install]
WantedBy=multi-user.target
```
Wants=network.target - Pyrkii käynnistymään vasta kun network on päällä
ExecStart/ExecStop/ExecReload - Skriptit jotka käynnistävät, sammuttavat ja uudelleenkäynnistävät teamspeak-palvelimen

Tämän jälkeen käynnistin ja enablesin ts3serverin ja otin talteen sen generoiman salasanan ja admin-tokenin.
```
$ sudo journalctl -xe -u ts3server | grep password
$ sudo journalctl -xe -u ts3server | grep token
```
Lopuksi vielä avasin ufw:n portit 9987/udp, 30033/tcp, 10011/tcp ja 41144/tcp

Servu käynnissä:

<img width="1103" height="400" alt="eka_servukokeilu_käynnissä" src="https://github.com/user-attachments/assets/62bdb273-443d-4bbd-a9be-316737296f87" />

Yhdistin hostikoneella clientillä testiksi:

<img width="567" height="88" alt="tessuservu_skulaa" src="https://github.com/user-attachments/assets/7573cbee-62a2-48de-848f-9486dd2c939a" />


## Mites tää automatisoidaan?
Aloitin resetoimalla testikoneen ja hyväksymällä masterilla sen avaimen. Loin /srv/salt/ kansion ja sinne tilatiedoston "user". Sen siältämään init-tiedostoon määritin yksinkertaisen käyttäjänluonnin:

<img width="261" height="78" alt="eka_teamspeak_käyttäjä_init" src="https://github.com/user-attachments/assets/4ec72e45-5883-4aab-a5c6-687132542f3e" />
<img width="342" height="75" alt="käyttäjä_luotu" src="https://github.com/user-attachments/assets/4366ebe6-68ef-4ef4-b11c-b3f5b67b2561" />

Tämän jälkeen loin tilatiedoston "ts3", johon aloin määritellä lbzip2 asennusta ja palvelintiedostojen latausta.

<img width="176" height="64" alt="lbzip2_asennus" src="https://github.com/user-attachments/assets/87f38dd7-3a0d-4558-8597-a8694dfbf1d9" />

<img width="1070" height="133" alt="lataa_servu_tar" src="https://github.com/user-attachments/assets/57517720-2b56-4013-91cf-260eb9105b2a" />

Määritin ladatun tar-tiedoston purun niin että tiedostot päätyvät kotihakemistoon ilman että ne sisältänyt kansio tulee mukana:

<img width="1091" height="132" alt="latauksen_untarraus" src="https://github.com/user-attachments/assets/590c5b1f-a60d-4511-8d3e-62b8f4cf36c7" />
Lopuksi päätin vielä yhdistää käyttäjänluonnin samaan tiedostoon jotta nämä kaikki voisi ajaa yhdestä tilasta.

<img width="1805" height="520" alt="käyttäjä_ja_lataus_init" src="https://github.com/user-attachments/assets/e82a8b7d-f0df-4c93-a0d4-facfbe69c370" />

Testasin ajaa tilan masterilta:

<img width="1250" height="978" alt="ajettu_ts3_tila" src="https://github.com/user-attachments/assets/0c22d6d0-d8ed-4667-94af-416ba041e7ca" />
Käyttäjä oli valmiina, mutta kaikki asentui ja latasi oikein.
Ajoin tilan vielä uudestaan:

<img width="1159" height="865" alt="ts3_uudelleenajo" src="https://github.com/user-attachments/assets/267d4333-b134-4ff1-92f1-5df61143974d" />


Tarkistin vielä että teidostot olivat oikeassa paikassa:

<img width="886" height="134" alt="lataus_ja_purku_tulos" src="https://github.com/user-attachments/assets/8c815381-0f16-4c79-85a9-a0c05d38d657" />


Tämän jälkeen lisäsin lisenssin hyväksymisen, joka tapahtuu luomalla uusi tyhjä teidosto:

<img width="959" height="86" alt="hyväksyy_lisenssin" src="https://github.com/user-attachments/assets/2c6b2465-1dc3-44af-a2a0-34f1b298d1a0" />

<img width="702" height="378" alt="lisenssi_hyväksytty" src="https://github.com/user-attachments/assets/a83b959e-6d5b-47a1-bbe0-7e29abafd355" />

Loppuun mieleeni juolahti vielä palomuurin asennus. Lisäsin tiedostoon vielä ufw:lle asennuksen sekä aktivoinnin ja uudelleenlatauksen:

<img width="675" height="201" alt="ufw_asennus_ja_aktivointi" src="https://github.com/user-attachments/assets/53574c4e-7d14-4486-ac98-d4e46a9f7449" />

Parini teki sillä välin toisen tilan joka luo ts3server palvelun, käynnistää palvelimen, ottaa talteen admin salasanan ja tokenin sekä avaa palomuurista oikeat portit.

## Lähteet:


https://www.transip.eu/knowledgebase/3346-installing-teamspeak-server-in-linux

https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files
